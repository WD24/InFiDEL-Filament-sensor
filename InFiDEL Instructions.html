<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice 4.1.7  (Win32)">
	<META NAME="CREATED" CONTENT="20210822;12153337">
	<META NAME="CHANGED" CONTENT="20210822;14254578">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 2cm }
		P { margin-bottom: 0.21cm }
		P.western { so-language: en-GB }
		A:link { so-language: zxx }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-GB" DIR="LTR">
<P CLASS="western" STYLE="margin-bottom: 0cm"><B>In</B>line <B>Fi</B>lament
<B>D</B>iameter by <B>E</B>stimation <B>L</B>ow-cost <B>InFiDEL</B></P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal">Original
work created by Thomas Sanladerer</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><A HREF="https://www.prusaprinters.org/prints/57154-infidel-inline-filament-diameter-estimator-lowcost">https://www.prusaprinters.org/prints/57154-infidel-inline-filament-diameter-estimator-lowcost</A></P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal">Further
development by Daniel Smullen</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><A HREF="https://github.com/drspangle/infidel-sensor/">https://github.com/drspangle/infidel-sensor/</A></P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="font-weight: normal"><EM>A cheap, yet
precise filament diameter sensor, intended to compensate for filament
diameter deviations in real-time.</EM></P>
<P CLASS="western">The InFiDEL is a cheap (&lt; $5) filament diameter
sensor intended for use with FDM 3d printers. The sensor can be
calibrated to provide surprisingly precise filament diameter readings
in real-time. The main idea is to use the sensor to correct for
filament diameter deviations while printing.</P>
<P CLASS="western">Based on this proof-of-concept:
<A HREF="https://www.youmagine.com/designs/filament-diameter-sensor">https://www.youmagine.com/designs/filament-diameter-sensor</A></P>
<P CLASS="western">Detailed documention for InFiDEL:
<A HREF="https://drspangle.github.io/infidel-sensor/">https://drspangle.github.io/infidel-sensor/</A></P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal">Please
refer to Daniel's github page
<A HREF="https://github.com/drspangle/infidel-sensor/">https://github.com/drspangle/infidel-sensor/</A>
or Thomas's Prusaprinters page for original files and more
information.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal">I
tried to make the InFiDEL sensor but I was having problems getting
reliable results from my build. That's probably more to do with my
abilities not anyone else. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal">Here's
my version of the firmware.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><B>Instructions</B></P>
<P CLASS="western" STYLE="margin-bottom: 0cm; font-weight: normal"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><SPAN STYLE="font-weight: normal">Build
the sensor as per the instructions on
</SPAN><A HREF="https://drspangle.github.io/infidel-sensor/">https://drspangle.github.io/infidel-sensor/</A>
 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">upload the
ATTINY_Calibration sketch to the InFiDEL and the
Arduino_Uno_Master_Calibration sketch to an arduino. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Connect the InFiDEL to
the arduino via the I2C pins.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Open a serial window in
the arduino IDE. The InFiDEL will start outputting smoothed Analog
data.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Use a selection of
measured rods such as the shank of a drill between the sizes of 1.0mm
and 2.0mm. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">In a spread sheet
record the analog output along with the diameter of the drill. I've
used open office calc, microsoft excel will do the do the next bit
the same.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Create the table with
the measured diameters of the drills and the analog reading (ADC)</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Diameter	ADC</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">2.00		470</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">1.60		414 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">1.55		404</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Highlight your data and
create a chart, choose a &ldquo;X-Y Scatter&rdquo; displaying points
only click next.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">For choose a data range
make sure the: &ldquo;data series in columns&rdquo; , &ldquo;First
row as label&rdquo;   are both checked then click finish</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">a new chart will
appear. Now right click on one of the data points and choose to
&ldquo;insert trend line&rdquo;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><IMG SRC="InFiDEL%20Instructions_html_m11492277.jpg" NAME="graphics1" ALIGN=LEFT WIDTH=643 HEIGHT=482 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">In the new window under
the type tab choose which type of trend line you want. Make sure the
&ldquo;Show Equation&rdquo; and &ldquo;Show Coefficient of
determination (R2)&rdquo; check boxes are ticked and then click OK</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><IMG SRC="InFiDEL%20Instructions_html_m7c402c81.jpg" NAME="graphics2" ALIGN=LEFT WIDTH=643 HEIGHT=482 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">The &ldquo;R2 =&rdquo;
number shows how reliable the formula is. The closer to 1.0 the
better. At this point I tried both the  Logarithmic and linear trend
lines and used the one where R2 was closes to 1.0</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">in this case the
Logarithmic.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><IMG SRC="InFiDEL%20Instructions_html_18891098.gif" NAME="Object1" ALIGN=LEFT WIDTH=605 HEIGHT=340><BR CLEAR=LEFT>The
formula f(x) = 416.22 ln(x) + 208.47 is for the data set I created
yours may be different. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">The f(x) is basically
the y axis on the chart or the ATTiny's analog output. And the x in
the formula is the diameter.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Now open the
InFiDEL_ATTiny sketch in the Arduino IDE.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Scroll down to the
pre-setup section titled &ldquo;formula&rdquo; about line 53.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">change the lines 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">int Smallest_Diameter =
96;  // 0.96mm* 100</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">int Largest_Diameter =
200;  // 2.00mm* 100</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">int Lower_ADC = 183;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">int Higher_ADC = 470;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">from your data set the
smallest diameter drill I used was 0.96mm so put that in as 96 for
Smallest_Diameter  and the corresponding ADC reading for Lower_ADC.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Do the same for the
largest diameter drill in your data set. The sketch uses this to
decide if the filament is out of range e.g. too thin or not resent.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Next scroll down to the
appropriate section depending on if you chose to use a linear graph
or a logarithmic graph. About line 67 or line 80</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">/*</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">  A Logarithmic graph
may produce better results if you have more data points in the
calibration</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">   Logarithmic diameter
from Open Office</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">   f(x)= 416.2165
In(x)+208.4720</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">   LogarithmicDia =
exp((average - 208.472) / 416.2165)</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">   LogarithmicDia =
exp((average - Logarithmic_RAW_A) / Logarithmic_RAW_B);</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">*/</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">#define
Logarithmic_RAW_A 208.472</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">#define
Logarithmic_RAW_B 416.2165</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">the lines:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Logarithmic diameter
from Open Office</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"> f(x)= 416.2165
In(x)+208.4720</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">show the formula
generated by open office yours might be slightly different. The next
two lines show how I adapted it to work on the Arduino IDE all you
need to change are the lines:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">#define
Logarithmic_RAW_A 208.472</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">#define
Logarithmic_RAW_B 416.2165</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">change the 208.472 and
the 416.2165 to the appropriate numbers from your dataset. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">The same applies for a
linear graph.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">If you just want to use
the InFiDEL as a filament runout sensor and not to measure the
diameter then you do not need to calculate either the linear or
logarithmic graphs.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Next scroll down to the
section in the void loop() commented as &ldquo;//Calculate diameter&rdquo;,
about line 144. a  logarithmic calculation is set by default.</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">if you wish to use the
basic function uncomment the line 151:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">//Diameter = Dia/100; 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">to read:  
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Diameter = Dia/100;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">and comment out line
157:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Diameter = exp((average
- Logarithmic_RAW_A) / Logarithmic_RAW_B);</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">to read:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">//Diameter =
exp((average - Logarithmic_RAW_A) / Logarithmic_RAW_B);</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">for a linear
calculation uncomment line 154:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">//Diameter = (average +
Linear_RAW_A) / Linear_RAW_B;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">to read:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">//Diameter = (average +
Linear_RAW_A) / Linear_RAW_B;</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">and comment out line
157:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Diameter = exp((average
- Logarithmic_RAW_A) / Logarithmic_RAW_B);</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">to read:</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">//Diameter =
exp((average - Logarithmic_RAW_A) / Logarithmic_RAW_B);</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">Now upload the sketch
to the InFiDEL and also upload the InFiDEL_Master_Reader sketch to an
Arduino, connect each other via the I2C pins and open a serial window
and every two seconds it should give a filament reading. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm"><BR>
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm">The LED on the InFiDEL
should light-up and the FAULT pin should go HIGH if no filament is
detected.</P>
</BODY>
</HTML>